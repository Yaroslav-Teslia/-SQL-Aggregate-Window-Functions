Завдання на SQL Aggregate Window Functions
1. Підрахунок фільмів за роками: Знайди кількість фільмів, випущених кожного року, використовуючи функцію COUNT() у віконній функції. Результат має включати стовпці: назва фільму, рік випуску, кількість фільмів у цьому році.
SELECT "Movie Name",
       "Release Year",
       COUNT(*) OVER(PARTITION BY "Release Year") AS nmb_in_the_year
FROM movies
ORDER BY nmb_in_the_year DESC

2. Середня тривалість фільмів за жанром: Розрахуй середню тривалість фільмів для кожного жанру за допомогою AVG().
SELECT "Movie Name",
       ROUND(AVG("Duration") OVER (PARTITION BY "Genre"), 0) AS avg_duration_by_genre
FROM movies

3.Максимальний рейтинг IMDB у кожному жанрі: Знайди максимальний рейтинг IMDB для кожного жанру, додавши нову колонку до таблиці.
SELECT *,
       MAX("IMDB Rating") OVER (PARTITION BY "Genre") AS max_rating_by_genre
FROM movies

4.Касові збори в жанрі: Розрахуй загальні касові збори (Gross) для кожного жанру, використовуючи функцію SUM(). (Спочатку потрібно видалити символ $ і коми, а потім конвертувати дані у числовий формат.)
WITH cte AS (
    SELECT *, 
           CAST(REPLACE(REPLACE(REPLACE("Gross", '$', ''), 'M', ''), '.', '') AS INTEGER) AS gross_clean
    FROM movies
    WHERE "Gross" != 'NA'
)
SELECT *,
       SUM(gross_clean) OVER (PARTITION BY "Genre") AS sum_gross_by_genre
FROM cte

5.Середня оцінка Metascore для кожного режисера: Використай AVG() у віконній функції, щоб знайти середню оцінку Metascore для кожного режисера.
SELECT *,
       ROUND(AVG("Metascore") OVER (PARTITION BY "Director"), 2) AS avg_metascore_by_director
FROM movies
WHERE "Metascore" IS NOT NULL

6. Фільм із мінімальною тривалістю в кожному жанрі: Знайди назву фільму та його тривалість для найкоротшого фільму в кожному жанрі.
WITH cte AS (
    SELECT *,
           MIN("Duration") OVER (PARTITION BY "Genre") AS min_duration_by_genre
    FROM movies
)
SELECT "Movie Name",
       "Duration"
FROM cte
WHERE min_duration_by_genre = "Duration"

7. Зростання кількості голосів у межах року: Для кожного фільму обчисли різницю між кількістю голосів цього фільму та попереднього (по року випуску), використовуючи LAG().
WITH cte AS (
    SELECT *,
           CAST(REPLACE("Votes", ',', '') AS INTEGER) AS votes_int
    FROM movies
)
SELECT *,
       lag_votes - votes_int AS diff_votes
FROM (
    SELECT *,
           LAG(votes_int) OVER (PARTITION BY "Release Year") AS lag_votes
    FROM cte
)

8. Рейтинг IMDB у межах режисера: Визнач фільм із найвищим рейтингом IMDB для кожного режисера. Виведи режисера, назву фільму та рейтинг.
WITH cte AS (
    SELECT *,
           MAX("IMDB Rating") OVER (PARTITION BY "Director") AS max_director_rating
    FROM movies
)
SELECT "Director",
       "Movie Name",
       "IMDB Rating"
FROM cte
WHERE "IMDB Rating" = max_director_rating

9. Найбільш прибутковий жанр по роках: Для кожного року визнач жанр із найбільшими загальними касовими зборами. Результат повинен включати рік, жанр і касові збори.
WITH cte AS (
    SELECT *,
           CAST(REPLACE(REPLACE(REPLACE("Gross", '$', ''), 'M', '0'), '.', '') AS INTEGER)*1000 AS gross_int
    FROM movies
    WHERE "Gross" != 'NA'
)
SELECT "Release Year",
       "Genre",
       gross_int,
       MAX(gross_int) OVER (PARTITION BY "Release Year", "Genre") AS max_gross_by_year_genre
FROM cte
